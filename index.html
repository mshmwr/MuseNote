<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini éˆæ„Ÿç­†è¨˜æœ¬</title>
    <!-- è¼‰å…¥ Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- è¨­å®š Inter å­—é«” -->
    <style>
        body {font-family: 'Inter', sans-serif;background-color: #f7f9fb;}
        /* éš±è—åŸç”Ÿ number input çš„ç®­é ­ */
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button {
                -webkit-appearance: none;
                margin: 0;
        }
        .tag-pill {cursor: pointer;transition: transform 0.1s;}
        .tag-pill:hover {transform: translateY(-1px);box-shadow: 0 1px 2px rgba(0,0,0,0.1);}
        .tag-pill.active-filter {outline: 2px solid #3b82f6; transform: scale(1.05);font-weight: 600;}
        /* ç¢ºä¿æ—¥æœŸè¼¸å…¥æ¡†åœ¨ä¸åŒç€è¦½å™¨ä¸‹å¤–è§€ä¸€è‡´ */
    input[type="date"]::-webkit-calendar-picker-indicator {
        cursor: pointer;
    }

    /* --- æ–°å¢ï¼šæª¢è¦–æ¨¡å¼æŒ‰éˆ•æ¨£å¼ --- */
    .view-mode-button.active {
        background-color: #9333ea; /* purple-700 */
        color: white;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }
        .view-mode-button:not(.active) {
            background-color: #e5e7eb; /* bg-gray-200 */
            color: #374151; /* text-gray-700 */
        }
        .view-mode-button:not(.active):hover {
            background-color: #d1d5db; /* bg-gray-300 */
        }
    
    /* --- æ–°å¢ï¼šæ—¥æ›†æª¢è¦–æ¨£å¼ --- */
    .calendar-grid {
        display: grid;
        grid-template-columns: repeat(7, 1fr);
        gap: 1px;
        background-color: #ddd;
        border: 1px solid #ddd;
        border-radius: 8px;
        overflow: hidden;
    }
    .day-cell {
        min-height: 80px; 
        padding: 6px;
        background-color: white;
        position: relative;
        user-select: none;
    }
    .day-cell.other-month {
        background-color: #f3f4f6;
        color: #9ca3af;
    }
    .day-header {
        text-align: center;
        font-weight: 600;
        padding: 8px 0;
        background-color: #e5e7eb;
        color: #4b5563;
    }
    .note-square {
        width: 12px;
        height: 12px;
        border-radius: 3px;
        margin: 1px;
        display: inline-block;
        cursor: pointer;
        transition: transform 0.1s;
        box-shadow: 0 0 1px rgba(0,0,0,0.5);
    }
    .note-square:hover {
        transform: scale(1.2);
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
    }
</style>
</head><body class="min-h-screen p-4 sm:p-8 flex items-start justify-center"><div id="app-container" class="w-full max-w-2xl bg-white shadow-2xl rounded-xl p-6 sm:p-8 mt-10">
    <h1 class="text-3xl font-extrabold text-gray-900 mb-6 text-center border-b pb-3">
        éˆæ„Ÿç­†è¨˜æœ¬ âœ¨
    </h1>

    <!-- æœå°‹èˆ‡ç¯©é¸å€å¡Š -->
    <div class="mb-6 space-y-4">
        <input type="text" id="search-input" placeholder="ğŸ” é—œéµå­—æœå°‹ (æ¨™é¡Œ/å‚™è¨»)..."
               class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 text-gray-700">
        
        <div id="tag-filter-container" class="border p-3 rounded-lg bg-gray-50">
            <p class="font-semibold text-sm text-gray-600 mb-2">é»æ“Šæ¨™ç±¤é€²è¡Œç¯©é¸ï¼š</p>
            <div id="tag-filter-list" class="flex flex-wrap gap-2">
                <!-- æ¨™ç±¤ç¯©é¸åˆ—è¡¨æœƒåœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                <span id="no-tags-message" class="text-gray-400 text-sm">ç„¡å¯ç”¨æ¨™ç±¤</span>
            </div>
        </div>
    </div>

    <!-- éŒ¯èª¤æˆ–è¨Šæ¯é¡¯ç¤ºå€ -->
    <p id="message" class="text-sm text-center text-red-500 mb-4 h-5"></p>

    <!-- æ–°å¢éˆæ„Ÿå€å¡Š -->
    <div class="bg-gray-100 p-5 rounded-xl mb-6 shadow-inner">
        <h2 class="text-xl font-bold text-gray-800 mb-3">æ–°å¢éˆæ„Ÿç­†è¨˜</h2>
        <div class="space-y-3">
            <input type="text" id="title-input" placeholder="æ¨™é¡Œ (å¿…å¡«)"
                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500">
            <textarea id="remark-input" placeholder="å‚™è¨»æˆ–è©³ç´°å…§å®¹ (æ”¯æ´å¤šè¡Œ)" rows="3"
                      class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500"></textarea>
            
            <!-- æ—¥æœŸè¼¸å…¥æ¬„ä½ -->
            <input type="date" id="date-input" title="éˆæ„Ÿæ—¥æœŸ"
                   class="w-full p-2 border border-gray-300 rounded-lg text-gray-700 focus:ring-purple-500">
                   
            <input type="url" id="url-input" placeholder="ç›¸é—œ URL é€£çµ (å¯é¸)"
                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500">
            <input type="url" id="image-url-input" placeholder="åœ–ç‰‡ URL (å¯é¸)"
                   class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500">
            
            <!-- æ¨™ç±¤è¼¸å…¥èˆ‡å»ºè­° (ä¸‹æ‹‰é¸å–®å¼é¸æ“‡) -->
            <div class="relative">
                <input type="text" id="tag-input" placeholder="æ¨™ç±¤ (è¼¸å…¥é—œéµå­—å¾Œï¼Œå¯å¾ä¸‹æ‹‰é¸å–®ä¸­é»é¸æˆ–æ–°å¢å¤šå€‹æ¨™ç±¤ï¼Œè«‹ç”¨é€—è™Ÿåˆ†éš”)"
                       class="w-full p-2 border border-gray-300 rounded-lg focus:ring-purple-500">
                <div id="tag-suggestions" class="absolute z-10 w-full bg-white border border-gray-200 rounded-lg shadow-lg max-h-40 overflow-y-auto hidden mt-1">
                    <!-- æ¨™ç±¤å»ºè­°æœƒåœ¨é€™è£¡å‹•æ…‹è¼‰å…¥ -->
                </div>
            </div>
            
            <button id="add-button" disabled
                    class="w-full bg-purple-600 hover:bg-purple-700 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition duration-150 ease-in-out disabled:opacity-50">
                ğŸ’¾ å„²å­˜éˆæ„Ÿ
            </button>
        </div>
    </div>
    
    <!-- æª¢è¦–æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
    <div class="mb-6 flex justify-center space-x-4">
        <button id="view-calendar-btn" data-mode="calendar" class="view-mode-button active px-4 py-2 text-sm rounded-lg font-semibold shadow-md">ğŸ“… æ—¥æ›†æª¢è¦–</button>
        <button id="view-list-btn" data-mode="list" class="view-mode-button px-4 py-2 text-sm rounded-lg font-semibold">ğŸ“‹ æ¸…å–®æª¢è¦–</button>
        <button id="view-tags-btn" data-mode="tags" class="view-mode-button px-4 py-2 text-sm rounded-lg font-semibold">ğŸ·ï¸ æ¨™ç±¤åˆ†é¡</button>
    </div>

    <!-- è¼‰å…¥è¨Šæ¯ -->
    <p id="loading-message" class="text-center text-gray-500 py-8">
        è¼‰å…¥ä¸­... æ­£åœ¨å˜—è©¦é€£ç·šåˆ°è³‡æ–™åº«... (è«‹ç­‰å¾…æ­¤è¨Šæ¯æ¶ˆå¤±)
    </p>
    
    <!-- å‹•æ…‹æª¢è¦–å®¹å™¨ -->
    <div id="calendar-container" class="space-y-4">
        <!-- æ—¥æ›†å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
    </div>
    <div id="notes-list" class="space-y-4 hidden">
        <!-- æ¸…å–®æª¢è¦–å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
    </div>
    <div id="tag-group-list" class="space-y-4 hidden">
        <!-- æ¨™ç±¤åˆ†é¡æª¢è¦–å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
    </div>

    <!-- ä½¿ç”¨è€… ID é¡¯ç¤º -->
    <p class="mt-8 text-xs text-gray-400 text-center">
        ä½¿ç”¨è€… ID: <span id="user-id-display" class="font-mono text-gray-600 break-all"></span>
    </p>
</div>

<!-- æ¨¡æ…‹è¦–çª— (Modal) ç”¨æ–¼é¡¯ç¤ºç­†è¨˜è©³æƒ… -->
<div id="note-detail-modal" class="fixed inset-0 bg-gray-900 bg-opacity-75 hidden items-center justify-center z-50 p-4" onclick="document.getElementById('note-detail-modal').classList.add('hidden')">
    <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md" onclick="event.stopPropagation()">
        <div class="flex justify-between items-start border-b pb-3 mb-4">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-900"></h3>
            <button onclick="document.getElementById('note-detail-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-700">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
            </button>
        </div>
        <p id="modal-date" class="text-sm text-gray-500 font-medium mb-3"></p>
        <img id="modal-image" class="w-full h-40 object-cover rounded-lg mb-4 hidden" alt="éˆæ„Ÿåœ–ç‰‡" />
        <p id="modal-remark" class="text-gray-700 whitespace-pre-wrap mb-4 border-t pt-4"></p>
        <a id="modal-url" href="#" target="_blank" class="text-blue-500 hover:text-blue-700 text-sm truncate block hidden mb-4"></a>
        <div id="modal-tags" class="flex flex-wrap gap-2 pt-2 border-t border-gray-100"></div>
    </div>
</div>


<!-- Firebase è…³æœ¬ -->
<script type="module">
    // 1. è¼‰å…¥ Firebase å¿…è¦çš„æ¨¡çµ„
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { 
        getAuth, 
        signInAnonymously,
        signInWithCustomToken, 
        onAuthStateChanged 
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
    import { 
        getFirestore, 
        collection, 
        addDoc, 
        onSnapshot, 
        doc, 
        setDoc,
        deleteDoc,
        query
    } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

    // =========================================================================
    // 2. Firebase é…ç½®èˆ‡åˆå§‹åŒ– (ä½¿ç”¨ç’°å¢ƒæä¾›çš„å…¨åŸŸè®Šæ•¸)
    // =========================================================================
    
    // å¿…é ˆä½¿ç”¨ç’°å¢ƒè®Šæ•¸ä¾†ç¢ºä¿èªè­‰æˆåŠŸ
    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id'; 
    const firebaseConfig = {
        apiKey: "AIzaSyBzK2UxhifdMZ34euxWr24YaUh3od6t09U",
        authDomain: "musenote-1a5ec.firebaseapp.com",
        projectId: "musenote-1a5ec",
        storageBucket: "musenote-1a5ec.firebasestorage.app",
        messagingSenderId: "726344810412",
        appId: "1:726344810412:web:042538d7fc627c99a54409",
        measurementId: "G-2N38R93PEQ"
    };
    const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;


    let app;
    let db;
    let auth;
    let userId = null;
    let isAuthReady = false;
    let allInspirations = []; 
    let tagMetadata = {};     
    let selectedTags = [];    
    let currentViewMode = 'calendar'; // é è¨­ç‚ºæ—¥æ›†æª¢è¦–
    let currentCalendarDate = new Date(); // ç•¶å‰æ—¥æ›†é¡¯ç¤ºçš„æœˆä»½

    // DOM å…ƒç´ 
    const titleInput = document.getElementById('title-input');
    const remarkInput = document.getElementById('remark-input');
    const dateInput = document.getElementById('date-input'); 
    const urlInput = document.getElementById('url-input');
    const imageUrlInput = document.getElementById('image-url-input');
    const tagInput = document.getElementById('tag-input');
    const addButton = document.getElementById('add-button');
    const messageDisplay = document.getElementById('message');
    const loadingMessage = document.getElementById('loading-message');
    const userIdDisplay = document.getElementById('user-id-display');
    const searchInput = document.getElementById('search-input');
    const tagSuggestions = document.getElementById('tag-suggestions');
    const tagFilterList = document.getElementById('tag-filter-list');
    const noTagsMessage = document.getElementById('no-tags-message');
    
    // æª¢è¦–å®¹å™¨
    const calendarContainer = document.getElementById('calendar-container');
    const notesList = document.getElementById('notes-list');
    const tagGroupList = document.getElementById('tag-group-list');
    
    // æª¢è¦–åˆ‡æ›æŒ‰éˆ•
    const viewModeButtons = document.querySelectorAll('.view-mode-button');

    // Tailwind é è¨­é¡è‰²é™£åˆ— (ç”¨æ–¼æ–°æ¨™ç±¤)
    const tagColors = [
        'bg-blue-500', 'bg-green-500', 'bg-red-500', 'bg-yellow-500', 
        'bg-indigo-500', 'bg-pink-500', 'bg-purple-500', 'bg-teal-500'
    ];
    
    const dayNames = ['æ—¥', 'ä¸€', 'äºŒ', 'ä¸‰', 'å››', 'äº”', 'å…­'];

    // 3. å¯¦ç”¨å‡½æ•¸ï¼šé¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
    function showMessage(text, isError = true) {
        messageDisplay.textContent = text;
        messageDisplay.classList.toggle('text-red-500', isError);
        messageDisplay.classList.toggle('text-green-500', !isError);
        setTimeout(() => messageDisplay.textContent = '', 3000);
    }

    // 4. å–å¾— Firestore é›†åˆè·¯å¾‘
    function getInspirationsPath() {
        // ç§äººè³‡æ–™è·¯å¾‘: /artifacts/{appId}/users/{userId}/inspirations
        return `artifacts/${appId}/users/${userId}/inspirations`;
    }

    function getTagMetadataPath() {
        // æ¨™ç±¤ metadata è·¯å¾‘: /artifacts/{appId}/users/{userId}/tag_metadata
        return `artifacts/${appId}/users/${userId}/tag_metadata`;
    }

    // 5. æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
    const startApp = async () => {
        try {
            // é©—è­‰ Firebase é…ç½®æ˜¯å¦æœ‰æ•ˆ
            if (!firebaseConfig || typeof firebaseConfig !== 'object' || Object.keys(firebaseConfig).length === 0) {
                const errorMsg = 'âŒ Firebase é…ç½®ç„¡æ•ˆæˆ–ç‚ºç©ºã€‚è«‹æª¢æŸ¥ __firebase_config æ˜¯å¦æ­£ç¢ºè¨­å®šã€‚';
                console.error(errorMsg);
                loadingMessage.textContent = errorMsg;
                addButton.disabled = true;
                return;
            }

            // é©—è­‰å¿…è¦çš„é…ç½®å­—æ®µ
            const requiredFields = ['apiKey', 'authDomain', 'projectId'];
            const missingFields = requiredFields.filter(field => !firebaseConfig[field]);
            
            if (missingFields.length > 0) {
                const errorMsg = `âŒ Firebase é…ç½®ä¸å®Œæ•´ï¼Œç¼ºå°‘: ${missingFields.join(', ')}`;
                console.error(errorMsg, firebaseConfig);
                loadingMessage.textContent = errorMsg;
                addButton.disabled = true;
                return;
            }

            console.log('âœ… Firebase é…ç½®æœ‰æ•ˆï¼Œé–‹å§‹åˆå§‹åŒ–...');
            console.log('Firebase é …ç›®:', firebaseConfig.projectId);
            
            // åˆå§‹åŒ– Firebase App
            app = initializeApp(firebaseConfig);
            console.log('âœ… Firebase App å·²åˆå§‹åŒ–');
            
            // ç²å– Auth å’Œ Firestore å¯¦ä¾‹
            auth = getAuth(app);
            console.log('âœ… Firebase Auth å·²åˆå§‹åŒ–');
            
            db = getFirestore(app);
            console.log('âœ… Firebase Firestore å·²åˆå§‹åŒ–');

            // èªè­‰æµç¨‹ï¼šå„ªå…ˆä½¿ç”¨ custom token ç™»å…¥ï¼Œå¦å‰‡ä½¿ç”¨åŒ¿åç™»å…¥
            if (initialAuthToken) { 
                console.log('ä½¿ç”¨ custom token ç™»å…¥...');
                await signInWithCustomToken(auth, initialAuthToken); 
            } else { 
                console.log('ä½¿ç”¨åŒ¿åç™»å…¥...');
                await signInAnonymously(auth); 
            }

            onAuthStateChanged(auth, (user) => {
                if (user) {
                    userId = user.uid;
                    isAuthReady = true;
                    userIdDisplay.textContent = userId;
                    // èªè­‰å®Œæˆå¾Œï¼Œé–‹å§‹ç›£è½è³‡æ–™åº«
                    setupRealtimeListeners();
                    addButton.disabled = false; // å•Ÿç”¨å„²å­˜æŒ‰éˆ•
                    loadingMessage.classList.add('hidden');
                    console.log("âœ… Firebase èªè­‰æˆåŠŸï¼ŒuserId:", userId);
                } else {
                    // å¦‚æœç™»å…¥å¤±æ•—ï¼ŒæŒ‰éˆ•ä¿æŒç¦ç”¨
                    userId = null;
                    isAuthReady = false;
                    userIdDisplay.textContent = "æœªèªè­‰";
                    showMessage('âŒ ç„¡æ³•é€£æ¥ Firebaseï¼Œè«‹æª¢æŸ¥é…ç½®å’Œç¶²è·¯é€£ç·šã€‚', true);
                    addButton.disabled = true;
                    loadingMessage.classList.add('hidden');
                    console.error("âŒ Firebase èªè­‰å¤±æ•—");
                }
            });

        } catch (error) {
            console.error("âŒ Firebase åˆå§‹åŒ–æˆ–èªè­‰å¤±æ•—:", error);
            const errorMsg = error.code ? `Firebase éŒ¯èª¤ (${error.code}): ${error.message}` : `åˆå§‹åŒ–å¤±æ•—: ${error.message}`;
            showMessage(errorMsg, true);
            loadingMessage.textContent = `âŒ è¼‰å…¥å¤±æ•—: ${error.message}`;
            addButton.disabled = true;
        }
    }

    // 6. è™•ç†æ¨™ç±¤ (ä¿æŒä¸è®Š)
    async function processTags(tags) {
        const processedTags = tags.map(tag => tag.trim()).filter(tag => tag.length > 0);
        
        for (const tag of processedTags) {
            if (!tagMetadata[tag]) {
                const randomColor = tagColors[Math.floor(Math.random() * tagColors.length)];
                const tagDocRef = doc(db, getTagMetadataPath(), tag);
                
                await setDoc(tagDocRef, {
                    colorClass: randomColor
                }, { merge: true });
                tagMetadata[tag] = randomColor;
            }
        }
        return processedTags;
    }

    // 7. æ–°å¢éˆæ„Ÿç­†è¨˜
    async function addInspiration() {
        const title = titleInput.value.trim();
        const remark = remarkInput.value.trim();
        const inspirationDate = dateInput.value.trim(); 
        const url = urlInput.value.trim();
        const imageUrl = imageUrlInput.value.trim();
        const tagString = tagInput.value.trim();
        const tags = tagString.split(',').map(t => t.trim()).filter(t => t.length > 0);

        if (!title) {
            showMessage('âŒ è«‹è¼¸å…¥æ¨™é¡Œï¼', true);
            return;
        }
        
        if (!isAuthReady || !auth.currentUser) {
            showMessage('âŒ Firebase æœªæº–å‚™å¥½æˆ–æœªèªè­‰ã€‚è«‹æª¢æŸ¥é…ç½®ã€‚', true);
            console.error('Auth not ready:', { isAuthReady, currentUser: auth?.currentUser });
            return;
        }

        addButton.disabled = true; 

        try {
            const processedTags = await processTags(tags);
            const inspirationsCollectionRef = collection(db, getInspirationsPath());
            
            await addDoc(inspirationsCollectionRef, {
                title: title,
                remark: remark,
                inspirationDate: inspirationDate || null, 
                url: url,
                imageUrl: imageUrl,
                tags: processedTags,
                createdAt: Date.now()
            });

            titleInput.value = '';
            remarkInput.value = '';
            dateInput.value = ''; 
            urlInput.value = '';
            imageUrlInput.value = '';
            tagInput.value = '';
            showMessage('âœ… éˆæ„Ÿç­†è¨˜å„²å­˜æˆåŠŸï¼', false);
            console.log('âœ… ç­†è¨˜å·²å„²å­˜');

        } catch (error) {
            console.error("âŒ æ–°å¢éˆæ„Ÿå¤±æ•—:", error);
            showMessage(`âŒ æ–°å¢å¤±æ•—: ${error.message}`, true);
        } finally {
            addButton.disabled = false; 
        }
    }
    
    addButton.addEventListener('click', addInspiration);

    // 8. å¯¦æ™‚è³‡æ–™ç›£è½å™¨
    function setupRealtimeListeners() {
        if (!db || !userId) {
            console.error('âŒ ç„¡æ³•è¨­å®šç›£è½å™¨ï¼šdb æˆ– userId æœªå®šç¾©');
            return;
        }

        console.log('âœ… é–‹å§‹è¨­å®šå¯¦æ™‚ç›£è½å™¨...');

        // ç›£è½æ¨™ç±¤ metadata
        const tagMetadataRef = collection(db, getTagMetadataPath());
        onSnapshot(query(tagMetadataRef), (snapshot) => {
            const newTagMetadata = {};
            snapshot.docs.forEach(doc => {
                newTagMetadata[doc.id] = doc.data().colorClass;
            });
            tagMetadata = newTagMetadata;
            console.log('âœ… æ¨™ç±¤ metadata å·²æ›´æ–°ï¼Œå…±', Object.keys(tagMetadata).length, 'å€‹æ¨™ç±¤');
            renderTagFilters(); 
            filterAndRender(); 
        }, (error) => {
            console.error("âŒ æ¨™ç±¤ metadata ç›£è½å¤±æ•—:", error);
            showMessage(`âŒ æ¨™ç±¤è³‡æ–™åº«é€£æ¥éŒ¯èª¤: ${error.message}`, true);
        });

        // ç›£è½éˆæ„Ÿç­†è¨˜
        const inspirationsRef = collection(db, getInspirationsPath());
        onSnapshot(query(inspirationsRef), (snapshot) => {
            allInspirations = snapshot.docs.map(doc => ({
                id: doc.id,
                ...doc.data()
            }));
            allInspirations.sort((a, b) => b.createdAt - a.createdAt);
            console.log('âœ… éˆæ„Ÿç­†è¨˜å·²æ›´æ–°ï¼Œå…±', allInspirations.length, 'æ¢ç­†è¨˜');

            filterAndRender(); 
        }, (error) => {
            console.error("âŒ éˆæ„Ÿç­†è¨˜ç›£è½å¤±æ•—:", error);
            showMessage(`âŒ éˆæ„Ÿç­†è¨˜è³‡æ–™åº«é€£æ¥éŒ¯èª¤: ${error.message}`, true);
        });
    }

    // 9. è™•ç†ç¯©é¸å’Œæœå°‹é‚è¼¯ (æ ¸å¿ƒé‚è¼¯)
    function filterAndRender() {
        const query = searchInput.value.trim().toLowerCase();
        
        let filteredNotes = allInspirations.filter(note => {
            // 1. é—œéµå­—æœå°‹
            const matchesKeyword = !query || 
                                 (note.title && note.title.toLowerCase().includes(query)) || 
                                 (note.remark && note.remark.toLowerCase().includes(query));

            // 2. æ¨™ç±¤ç¯©é¸ (å¿…é ˆåŒ…å«æ‰€æœ‰é¸å®šçš„æ¨™ç±¤)
            const matchesTags = selectedTags.length === 0 || 
                                selectedTags.every(tag => (note.tags || []).includes(tag));
            
            // æ—¥æ›†æ¨¡å¼ä¸‹ï¼Œåªé¡¯ç¤ºæœ‰æ—¥æœŸçš„ç­†è¨˜
            if (currentViewMode === 'calendar' && !note.inspirationDate) {
                return false;
            }

            return matchesKeyword && matchesTags;
        });

        // æ ¹æ“šç•¶å‰æ¨¡å¼æ¸²æŸ“
        notesList.classList.add('hidden');
        calendarContainer.classList.add('hidden');
        tagGroupList.classList.add('hidden');

        if (currentViewMode === 'calendar') {
            renderCalendarView(filteredNotes);
            calendarContainer.classList.remove('hidden');
        } else if (currentViewMode === 'list') {
            renderListView(filteredNotes);
            notesList.classList.remove('hidden');
        } else if (currentViewMode === 'tags') {
            renderTagGroupView(filteredNotes);
            tagGroupList.classList.remove('hidden');
        }
    }

    // ç¶å®šæœå°‹è¼¸å…¥æ¡†äº‹ä»¶
    searchInput.addEventListener('input', filterAndRender);
    
    // ç¶å®šæª¢è¦–åˆ‡æ›æŒ‰éˆ•äº‹ä»¶
    viewModeButtons.forEach(button => {
        button.addEventListener('click', (e) => {
            currentViewMode = e.currentTarget.dataset.mode;
            viewModeButtons.forEach(btn => btn.classList.remove('active'));
            e.currentTarget.classList.add('active');
            filterAndRender(); 
        });
    });


    // 10. æ¸²æŸ“æ¨™ç±¤ç¯©é¸åˆ—è¡¨ (ä¿æŒä¸è®Š)
    function renderTagFilters() {
        tagFilterList.innerHTML = '';
        const allUniqueTags = Object.keys(tagMetadata).sort();

        if (allUniqueTags.length === 0) {
            noTagsMessage.classList.remove('hidden');
            return;
        }
        noTagsMessage.classList.add('hidden');

        // æ·»åŠ  'å…¨éƒ¨' æ¨™ç±¤
        const allTagEl = createTagPill('å…¨éƒ¨', 'bg-gray-200 text-gray-800', 'all');
        tagFilterList.appendChild(allTagEl);

        allUniqueTags.forEach(tag => {
            const color = tagMetadata[tag] || 'bg-gray-400';
            const textColor = color.includes('500') ? 'text-white' : 'text-gray-800';
            const tagEl = createTagPill(tag, `${color} ${textColor}`, tag);
            tagEl.classList.toggle('active-filter', selectedTags.includes(tag)); 
            tagFilterList.appendChild(tagEl);
        });

        if (selectedTags.length === 0) {
             allTagEl.classList.add('active-filter');
        } else {
             allTagEl.classList.remove('active-filter');
        }
    }

    function createTagPill(tagName, colorClass, filterValue) {
        const isFilterActive = filterValue === 'all' ? selectedTags.length === 0 : selectedTags.includes(filterValue);
        
        const pill = document.createElement('span');
        pill.textContent = tagName;
        pill.className = `tag-pill text-xs font-medium px-3 py-1 rounded-full shadow-sm ${colorClass} ${isFilterActive ? 'active-filter' : ''}`;
        pill.dataset.tag = filterValue;

        pill.addEventListener('click', () => {
            if (filterValue === 'all') {
                selectedTags = [];
            } else if (selectedTags.includes(filterValue)) {
                selectedTags = selectedTags.filter(t => t !== filterValue);
            } else {
                selectedTags.push(filterValue);
            }
            
            renderTagFilters();
            filterAndRender();
        });

        return pill;
    }

    // 11. æ¸²æŸ“æ¸…å–®æª¢è¦– (åŸ renderNotesï¼Œç¾æ”¹ç‚º ListView)
    function renderListView(notes) {
        notesList.innerHTML = ''; 

        if (notes.length === 0) {
            notesList.innerHTML = `
                <p class="text-center text-gray-500 py-8">
                    æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„éˆæ„Ÿç­†è¨˜ã€‚
                </p>
            `;
            return;
        }

        notes.forEach(note => {
            const noteElement = document.createElement('div');
            noteElement.className = `p-5 bg-white border border-gray-200 rounded-xl shadow-lg hover:shadow-xl transition duration-300 space-y-3`;
            
            // ... (Tags, URL, Image HTML ä¿æŒä¸è®Š)
            const tagsHTML = (note.tags || []).map(tag => {
                const color = tagMetadata[tag] || 'bg-gray-400';
                const textColor = color.includes('500') ? 'text-white' : 'text-gray-800';
                // ä½¿ç”¨ document.dispatchEvent è§¸ç™¼è‡ªè¨‚äº‹ä»¶ä¾†é¿å…åœ¨ HTML æ¨¡æ¿ä¸­ç›´æ¥åŸ·è¡Œè¤‡é›œ JS é‚è¼¯
                return `<span class="tag-pill text-xs font-medium px-2 py-0.5 rounded-full ${color} ${textColor}" data-tag="${tag}" onclick="document.dispatchEvent(new CustomEvent('filtertag', { detail: '${tag}' }))">${tag}</span>`;
            }).join('');

            const urlHTML = note.url ? `<a href="${note.url}" target="_blank" class="text-blue-500 hover:text-blue-700 text-sm truncate block mt-1">é€£çµ: ${note.url}</a>` : '';
            
            const imageHTML = note.imageUrl ? `<img src="${note.imageUrl}" alt="éˆæ„Ÿåœ–ç‰‡" class="mt-3 w-full h-40 object-cover rounded-lg" onerror="this.onerror=null; this.src='https://placehold.co/400x200/cccccc/333333?text=ç„¡æ³•è¼‰å…¥åœ–ç‰‡';" />` : '';

            const dateHTML = note.inspirationDate ? `<p class="text-sm text-gray-500 font-medium pt-1">æ—¥æœŸ: ${note.inspirationDate}</p>` : '';

            noteElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <h3 class="text-xl font-bold text-gray-900 pr-4">${note.title}</h3>
                    <div class="flex space-x-2 flex-shrink-0">
                        <!-- ç·¨è¼¯æŒ‰éˆ• -->
                        <button class="edit-note p-2 text-gray-500 hover:text-blue-600 rounded-full transition duration-150" data-id="${note.id}" onclick="showMessage('ç·¨è¼¯åŠŸèƒ½å¾…å»ºæ§‹', true)">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z"></path></svg>
                        </button>
                        <!-- åˆªé™¤æŒ‰éˆ• -->
                        <button class="delete-note p-2 text-red-500 hover:text-red-700 rounded-full transition duration-150" data-id="${note.id}">
                            <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                        </button>
                    </div>
                </div>

                ${dateHTML}
                ${imageHTML}

                <p class="text-gray-700 whitespace-pre-wrap">${note.remark}</p>
                
                ${urlHTML}

                <div class="flex flex-wrap gap-2 pt-2 border-t border-gray-100">
                    ${tagsHTML}
                </div>
            `;
            
            notesList.appendChild(noteElement);

            noteElement.querySelector('.delete-note').addEventListener('click', () => {
                deleteInspiration(note.id);
            });
        });
    }
    
    // 12. æ¸²æŸ“æ¨™ç±¤åˆ†é¡æª¢è¦–
    function renderTagGroupView(notes) {
        tagGroupList.innerHTML = '';
        
        if (notes.length === 0) {
            tagGroupList.innerHTML = `
                <p class="text-center text-gray-500 py-8">
                    æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„éˆæ„Ÿç­†è¨˜ã€‚
                </p>
            `;
            return;
        }

        const notesByTag = {};
        notes.forEach(note => {
            const tags = note.tags && note.tags.length > 0 ? note.tags : ['ç„¡æ¨™ç±¤'];
            tags.forEach(tag => {
                if (!notesByTag[tag]) {
                    notesByTag[tag] = [];
                }
                notesByTag[tag].push(note);
            });
        });

        Object.keys(notesByTag).sort().forEach(tag => {
            const tagSection = document.createElement('div');
            const color = tagMetadata[tag] || 'bg-gray-400';
            const textColor = color.includes('500') ? 'text-white' : 'text-gray-800';

            tagSection.className = 'mb-6 p-4 border rounded-xl shadow-lg bg-white';
            tagSection.innerHTML = `
                <h3 class="text-xl font-bold mb-3 pb-2 border-b">
                    <span class="px-3 py-1 rounded-full ${color} ${textColor} shadow-md">${tag}</span>
                    <span class="text-gray-500 text-sm ml-2">(${notesByTag[tag].length} å‰‡ç­†è¨˜)</span>
                </h3>
                <div class="space-y-3">
                    ${notesByTag[tag].map(note => `
                        <div class="p-3 border border-gray-100 rounded-lg hover:bg-gray-50 cursor-pointer" onclick="showNoteDetail('${note.id}')">
                            <p class="font-semibold text-gray-800 truncate">${note.title}</p>
                            <p class="text-xs text-gray-500">${note.inspirationDate || 'ç„¡æ—¥æœŸ'}</p>
                        </div>
                    `).join('')}
                </div>
            `;
            tagGroupList.appendChild(tagSection);
        });
    }
    
    // 13. æ¸²æŸ“æ—¥æ›†æª¢è¦– (æ–°çš„é è¨­æª¢è¦–)
    function renderCalendarView(notes) {
        calendarContainer.innerHTML = '';

        if (notes.length === 0) {
            calendarContainer.innerHTML = `
                <p class="text-center text-gray-500 py-8">
                    æ‰¾ä¸åˆ°ç¬¦åˆæ¢ä»¶çš„éˆæ„Ÿç­†è¨˜ã€‚
                </p>
            `;
            // return; // å³ä½¿æ²’æœ‰ç­†è¨˜ä¹Ÿæ‡‰è©²é¡¯ç¤ºæ—¥æ›†æ¡†æ¶
        }

        // 1. æº–å‚™æ•¸æ“š: å°‡ç­†è¨˜æŒ‰æ—¥æœŸåˆ†çµ„
        const notesByDate = {};
        notes.forEach(note => {
            if (note.inspirationDate) {
                if (!notesByDate[note.inspirationDate]) {
                    notesByDate[note.inspirationDate] = [];
                }
                notesByDate[note.inspirationDate].push(note);
            }
        });

        // 2. å°èˆªå’Œæ¨™é¡Œ
        const month = currentCalendarDate.getMonth();
        const year = currentCalendarDate.getFullYear();
        const monthNames = ["ä¸€æœˆ", "äºŒæœˆ", "ä¸‰æœˆ", "å››æœˆ", "äº”æœˆ", "å…­æœˆ", "ä¸ƒæœˆ", "å…«æœˆ", "ä¹æœˆ", "åæœˆ", "åä¸€æœˆ", "åäºŒæœˆ"];

        const header = document.createElement('div');
        header.className = 'flex justify-between items-center mb-4';
        header.innerHTML = `
            <button id="prev-month" class="text-purple-600 hover:text-purple-800 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path></svg>
            </button>
            <h2 class="text-xl font-bold text-gray-800">${year} å¹´ ${monthNames[month]}</h2>
            <button id="next-month" class="text-purple-600 hover:text-purple-800 p-2 rounded-full">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path></svg>
            </button>
        `;
        calendarContainer.appendChild(header);

        // 3. æ¸²æŸ“æ—¥æ›†ç¶²æ ¼
        const calendarGrid = document.createElement('div');
        calendarGrid.className = 'calendar-grid';

        // æ¸²æŸ“æ˜ŸæœŸæ¨™é ­
        dayNames.forEach(day => {
            const headerCell = document.createElement('div');
            headerCell.className = 'day-header';
            headerCell.textContent = day;
            calendarGrid.appendChild(headerCell);
        });

        // 4. è¨ˆç®—æ—¥æ›†æ—¥æœŸ
        const firstDayOfMonth = new Date(year, month, 1).getDay(); // 0 (Sun) - 6 (Sat)
        const daysInMonth = new Date(year, month + 1, 0).getDate();
        
        // å¡«å……ä¸Šä¸€å€‹æœˆçš„å¤©æ•¸ (å¦‚æœä¸æ˜¯å¾æ˜ŸæœŸæ—¥é–‹å§‹)
        for (let i = 0; i < firstDayOfMonth; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell other-month';
            calendarGrid.appendChild(dayCell);
        }

        // å¡«å……ç•¶æœˆå¤©æ•¸
        for (let day = 1; day <= daysInMonth; day++) {
            const dateString = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
            const notesToday = notesByDate[dateString] || [];
            
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell flex flex-col justify-between';
            dayCell.innerHTML = `
                <p class="text-sm font-semibold">${day}</p>
                <div class="flex flex-wrap items-end justify-start flex-grow">
                    ${notesToday.map(note => {
                        const firstTag = note.tags && note.tags[0];
                        const color = tagMetadata[firstTag] || 'bg-gray-400';
                        return `<span class="note-square ${color}" title="${note.title}" onclick="showNoteDetail('${note.id}')"></span>`;
                    }).join('')}
                </div>
            `;
            calendarGrid.appendChild(dayCell);
        }

        // å¡«å……ä¸‹ä¸€å€‹æœˆçš„å¤©æ•¸
        const totalCells = firstDayOfMonth + daysInMonth;
        const remainingCells = 42 - totalCells; // 42 cells = 6 weeks
        for (let i = 0; i < remainingCells && totalCells + i < 42; i++) {
            const dayCell = document.createElement('div');
            dayCell.className = 'day-cell other-month';
            calendarGrid.appendChild(dayCell);
        }

        calendarContainer.appendChild(calendarGrid);

        // 5. ç¶å®šå°èˆªäº‹ä»¶
        document.getElementById('prev-month').addEventListener('click', () => {
            currentCalendarDate = new Date(year, month - 1, 1);
            filterAndRender();
        });
        document.getElementById('next-month').addEventListener('click', () => {
            currentCalendarDate = new Date(year, month + 1, 1);
            filterAndRender();
        });
    }
    
    // 14. é¡¯ç¤ºç­†è¨˜è©³æƒ…æ¨¡æ…‹è¦–çª—
    window.showNoteDetail = (noteId) => {
        const note = allInspirations.find(n => n.id === noteId);
        if (!note) return;

        const modal = document.getElementById('note-detail-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalDate = document.getElementById('modal-date');
        const modalRemark = document.getElementById('modal-remark');
        const modalUrl = document.getElementById('modal-url');
        const modalImage = document.getElementById('modal-image');
        const modalTags = document.getElementById('modal-tags');
        
        modalTitle.textContent = note.title;
        modalDate.textContent = note.inspirationDate ? `æ—¥æœŸ: ${note.inspirationDate}` : 'æ—¥æœŸ: æœªè¨­å®š';
        modalRemark.textContent = note.remark;

        // è™•ç† URL
        if (note.url) {
            modalUrl.href = note.url;
            modalUrl.textContent = `å‰å¾€é€£çµ: ${note.url}`;
            modalUrl.classList.remove('hidden');
        } else {
            modalUrl.classList.add('hidden');
        }

        // è™•ç†åœ–ç‰‡
        if (note.imageUrl) {
            modalImage.src = note.imageUrl;
            modalImage.classList.remove('hidden');
            modalImage.onerror = function() {
                this.classList.add('hidden');
            }
        } else {
            modalImage.classList.add('hidden');
        }

        // è™•ç†æ¨™ç±¤
        modalTags.innerHTML = (note.tags || []).map(tag => {
            const color = tagMetadata[tag] || 'bg-gray-400';
            const textColor = color.includes('500') ? 'text-white' : 'text-gray-800';
            return `<span class="tag-pill text-xs font-medium px-2 py-0.5 rounded-full ${color} ${textColor}">${tag}</span>`;
        }).join('');


        modal.classList.remove('hidden');
        modal.style.display = 'flex'; // ç¢ºä¿é¡¯ç¤º
    }


    // 15. åˆªé™¤éˆæ„Ÿç­†è¨˜
    async function deleteInspiration(noteId) {
        try {
            const noteDocRef = doc(db, getInspirationsPath(), noteId);
            await deleteDoc(noteDocRef);
            showMessage('âœ… éˆæ„Ÿç­†è¨˜å·²åˆªé™¤ï¼', false);
            console.log('âœ… ç­†è¨˜å·²åˆªé™¤:', noteId);
        } catch (error) {
            console.error("âŒ åˆªé™¤ç­†è¨˜å¤±æ•—:", error);
            showMessage(`âŒ åˆªé™¤å¤±æ•—: ${error.message}`, true);
        }
    }

    // 16. æ¨™ç±¤è¼¸å…¥å»ºè­° (ä¿æŒä¸è®Š)
    tagInput.addEventListener('input', () => {
        const inputVal = tagInput.value.split(',').pop().trim().toLowerCase();
        tagSuggestions.innerHTML = '';
        
        if (inputVal.length > 0) {
            const enteredTags = tagInput.value.split(',').map(t => t.trim().toLowerCase());
            
            const uniqueTags = Object.keys(tagMetadata).filter(tag => 
                tag.toLowerCase().startsWith(inputVal) && !enteredTags.includes(tag.toLowerCase())
            );
            
            if (uniqueTags.length > 0) {
                tagSuggestions.classList.remove('hidden');
                uniqueTags.forEach(tag => {
                    const suggestionEl = document.createElement('div');
                    suggestionEl.textContent = tag;
                    suggestionEl.className = 'p-2 cursor-pointer hover:bg-purple-100 text-sm';
                    suggestionEl.addEventListener('click', () => {
                        let parts = tagInput.value.split(',');
                        parts.pop(); 
                        parts.push(tag); 
                        tagInput.value = parts.join(', ') + ', '; 
                        tagSuggestions.classList.add('hidden');
                        tagInput.focus();
                    });
                    tagSuggestions.appendChild(suggestionEl);
                });
                return;
            }
        }
        tagSuggestions.classList.add('hidden');
    });
    
    // 17. ç¶å®šå‹•æ…‹é»æ“Šæ¨™ç±¤äº‹ä»¶ (ä¿æŒä¸è®Š)
    document.addEventListener('filtertag', (e) => {
        const tag = e.detail;
        if (selectedTags.includes(tag)) {
            selectedTags = selectedTags.filter(t => t !== tag);
        } else {
            selectedTags.push(tag);
        }
        tagFilterList.scrollIntoView({ behavior: 'smooth' }); 
        renderTagFilters();
        filterAndRender();
    });

    // å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
    console.log('ğŸš€ MuseNote æ‡‰ç”¨æ­£åœ¨å•Ÿå‹•...');
    console.log('Firebase é…ç½®:', {
        hasApiKey: !!firebaseConfig?.apiKey,
        hasProjectId: !!firebaseConfig?.projectId,
        hasAuthDomain: !!firebaseConfig?.authDomain,
        projectId: firebaseConfig?.projectId || 'æœªè¨­å®š'
    });
    startApp();

</script>
</body></html>